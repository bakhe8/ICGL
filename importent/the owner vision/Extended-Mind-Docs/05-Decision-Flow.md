# `05-Decision-Flow.md`  
**دورة حياة القرار والتعارض والتنفيذ**

هذا الملف يحدد كيف تتحرك الفكرة داخل النظام منذ ولادتها حتى تتحول — أو لا تتحول — إلى فعل.  
هو ترجمة عملية لمبدأ الفصل بين:

> التفكير ← الاقتراح ← التعارض ← القرار ← التنفيذ

---

## 1. الكيانات الأساسية في دورة الحياة

كل ما يحدث داخل النظام يتم عبر “عقد” (Nodes):

- `IDEA` — فكرة خام  
- `NOTE` — ملاحظة أو توضيح  
- `JOURNAL_ENTRY` — حوار ذاتي  
- `PROPOSAL` — اقتراح منضبط  
- `CONFLICT` — حالة تعارض  
- `DECISION` — قرار سيادي  
- `EXPERIMENT` — تجربة  
- `ARTIFACT` — ناتج تنفيذ  

العقد ترتبط عبر `edges` لتكوين شبكة التفكير.

---

## 2. التدفق الأساسي: من فكرة إلى تنفيذ

### المرحلة 1 — الفكرة

- يقوم المستخدم بإنشاء `IDEA` في Workspace من نوع `NORMAL`.
- الحالة الافتراضية: `RAW` أو `OPEN`.
- لا توجد أي إلزامات:
  - لا حالة مطلوبة
  - لا Metadata إجباري
  - لا Workflow

الغرض:  
فتح مساحة للتفكير غير الخطي.

---

### المرحلة 2 — تشغيل الوكلاء

- المستخدم يختار:
  - تشغيل وكيل محدد
  - أو “Run All Agents”

- يتم إنشاء `agent_run` لكل وكيل.
- مخرجات الوكيل تُحفظ في:
  - `agent_runs.output`
  - ويمكن تحويلها إلى `PROPOSAL`

---

### المرحلة 3 — الاقتراح

- يتم إنشاء `PROPOSAL` مرتبط بالفكرة.
- يحتوي على قالب الاقتراح المنضبط:
  - Trigger
  - Impact
  - Risks
  - Alternatives
  - Effort
  - Execution Plan

الاقتراح يمكن أن يكون:

- مسودة
- مفتوحًا للنقاش
- مجمّدًا
- مؤرشفًا

ولا يحمل أي التزام.

---

### المرحلة 4 — كشف التعارض

- النظام أو المستخدم يشغّل:
  ```
  POST /conflicts/detect?node_id=...
  ```

- في حال وجود تضارب بين اقتراحين:
  - يتم إنشاء `CONFLICT`
  - تُجمّد المسارات المتداخلة
  - يُعرض التعارض ككيان مستقل

التعارض يحتوي:

- الاقتراحين المتعارضين
- ملخص الفروقات
- الأبعاد (أداء/أمان/تعقيد/…)
- الحالة: `OPEN`

---

### المرحلة 5 — الحسم السيادي

- المستخدم يراجع:
  - الاقتراحات
  - التعارضات
  - الملاحظات

ثم يختار:

- تأجيل
- تجميد
- أرشفة
- أو اعتماد

عند الاعتماد:

- يتم إنشاء `DECISION`
- يرتبط بـ `proposal_node_id`
- يُنشأ `approval_token`
- تُكتب `rationale`
- يُحدد `scope_guard`

الحالة تصبح: `APPROVED`

---

### المرحلة 6 — التنفيذ

- المستخدم يستدعي:
  ```
  POST /execute
  { decision_id, approval_token }
  ```

- محرك التنفيذ يتحقق من:
  - وجود القرار
  - حالة `APPROVED`
  - صحة الـ Token
  - احترام `scope_guard`

إذا فشل أي شرط:

- يتم رفض التنفيذ
- يُسجل حدث `EXECUTION_BLOCKED`

إذا نجح:

- يتم توليد المخرجات (كود / ملفات / وثائق)
- يُسجل `EXECUTION_RESULT`
- تُنشأ `ARTIFACTS`

---

## 3. تدفقات خاصة

### أ) التعارض كموضوع مستقل

- `CONFLICT` ليس حالة عابرة.
- يمكن:
  - فتحه
  - مناقشته
  - تشغيل وكلاء عليه
  - تأجيله
  - أو حسمه بقرار مستقل

---

### ب) Sandbox Mode

- Workspace من نوع `SANDBOX`
- يسمح بـ:
  - أفكار متطرفة
  - لعب
  - تجارب

القيود:

- لا يمكن ترقية أي محتوى منه إلى `NORMAL`
- لا يُستخدم لبناء قرارات رسمية
- كل ما فيه معزول

---

### ج) Journal Mode

- Workspace من نوع `JOURNAL`
- مخصص لـ:
  - الشكوك
  - الحوار الذاتي
  - الأفكار غير الموجهة للنظام

القيود:

- لا يدخل في التحليل الآلي إلا بطلب صريح
- عند الطلب:
  - يُسمح بالاطلاع فقط على ما شارك المستخدم في بنائه أو كتابته

---

## 4. حالات العقد (States)

أمثلة:

- `RAW`
- `OPEN`
- `IN_REVIEW`
- `DORMANT`
- `APPROVED`
- `REJECTED`
- `ARCHIVED`
- `FROZEN`
- `UNRESOLVED`

لا يُفرض تسلسل إجباري.

الانتقال بين الحالات:

- يتم يدويًا
- أو عبر أحداث واضحة
- ولا يُجبر على الحسم
